#!/bin/bash
################################################################################
# IBM API Connect v12.1.0.1 Deployment Configuration - v3
################################################################################
# This file contains all environment-specific variables for the deployment.
# Generated for: k8s.adp.example.com
#
# Usage:
#   source config.env
#   ./core/DEPLOY-CORE.txt
################################################################################

#==============================================================================
# CORE CONFIGURATION
#==============================================================================

# Package Metadata
export APIC_PACKAGE_NAME="v12.1.0.1-v3"
export APIC_PACKAGE_VERSION="12.1.0.1"
export APIC_PACKAGE_DESCRIPTION="IBM API Connect v12.1.0.1 on Kubernetes (Contour ingress)"

# Kubernetes Configuration
export APIC_NAMESPACE="ibm-apic"
export APIC_KUBECONFIG="${KUBECONFIG:-$HOME/.kube/config}"

#==============================================================================
# NETWORK CONFIGURATION
#==============================================================================

# DNS Domain (base domain for all services)
export APIC_DOMAIN_BASE="demo01.mea-presales.org"

# Ingress Configuration
export APIC_INGRESS_CLASS="contour"
export APIC_INGRESS_TYPE="contour"                    # Options: contour, nginx, traefik
export APIC_CONTOUR_NAMESPACE="projectcontour"
export APIC_CONTOUR_SERVICE_NAME="envoy"
export APIC_LOADBALANCER_IP=""                        # Auto-assign (no fixed IP)

# Service Hostnames (automatically constructed from APIC_DOMAIN_BASE)
export APIC_MGMT_ADMIN_HOST="admin-apic.${APIC_DOMAIN_BASE}"
export APIC_MGMT_MANAGER_HOST="manager-apic.${APIC_DOMAIN_BASE}"
export APIC_MGMT_PLATFORM_API_HOST="api-apic.${APIC_DOMAIN_BASE}"
export APIC_MGMT_CONSUMER_API_HOST="consumer-apic.${APIC_DOMAIN_BASE}"
export APIC_MGMT_CONSUMER_CATALOG_HOST="consumer-catalog-apic.${APIC_DOMAIN_BASE}"

export APIC_ANALYTICS_INGESTION_HOST="ai-apic.${APIC_DOMAIN_BASE}"

export APIC_DEVPORTAL_ADMIN_HOST="admin-devportal-apic.${APIC_DOMAIN_BASE}"
export APIC_DEVPORTAL_UI_HOST="devportal-apic.${APIC_DOMAIN_BASE}"

export APIC_WM_GATEWAY_HOST="wmapigw-apic.${APIC_DOMAIN_BASE}"
export APIC_WM_GATEWAY_UI_HOST="wmapigw-ui-apic.${APIC_DOMAIN_BASE}"

export APIC_AI_GATEWAY_HOST="ai-rgw-apic.${APIC_DOMAIN_BASE}"
export APIC_AI_GATEWAY_MANAGER_HOST="ai-rgwd-apic.${APIC_DOMAIN_BASE}"

export APIC_DP_GATEWAY_HOST="rgw-apic.${APIC_DOMAIN_BASE}"
export APIC_DP_GATEWAY_MANAGER_HOST="rgwd-apic.${APIC_DOMAIN_BASE}"

#==============================================================================
# CONTAINER REGISTRY CONFIGURATION
#==============================================================================

# Registry credentials (for creating pull secret)
export APIC_REGISTRY_SERVER="harbor.talos.zebra-cloud.net"
export APIC_REGISTRY_USERNAME="robot$apic-m4"
export APIC_REGISTRY_PASSWORD="NZTmUwu87w32XRLfjUe80tginusSzTLh"                          # Set this or use prompt

export APIC_IMAGE_REGISTRY="${APIC_REGISTRY_SERVER}/apic"
export APIC_IMAGE_PULL_POLICY="IfNotPresent"              # Options: Always, IfNotPresent, Never
export APIC_IMAGE_PULL_SECRET="harbor-registry-secret"

#==============================================================================
# STORAGE CONFIGURATION
#==============================================================================

export APIC_STORAGE_CLASS="nfs-ssd"
export APIC_BACKUP_STORAGE_CLASS="nfs-ssd"

# Storage sizes (optional - use CR defaults if not set)
# export APIC_MGMT_DB_SIZE="200Gi"
# export APIC_ANALYTICS_STORAGE_SIZE="200Gi"
# export APIC_WM_GATEWAY_STORAGE_SIZE="10Gi"

#==============================================================================
# CERTIFICATE CONFIGURATION
#==============================================================================

export APIC_CERT_MANAGER_NAMESPACE="cert-manager"
export APIC_CERT_ISSUER_NAME="ingress-issuer"
export APIC_CERT_ISSUER_KIND="ClusterIssuer"             # Options: ClusterIssuer, Issuer

# TLS Configuration
export APIC_TLS_ENABLED="true"
export APIC_CERT_MANAGER_ENABLED="true"

#==============================================================================
# SECRETS CONFIGURATION
#==============================================================================

# Management Cluster Admin
export APIC_MGMT_ADMIN_SECRET="management-admin-secret"
export APIC_MGMT_ADMIN_PASSWORD="Admin123!"

# DataPower Admin (for AI Gateway)
export APIC_DATAPOWER_ADMIN_SECRET="datapower-admin-credentials"
export APIC_DATAPOWER_ADMIN_PASSWORD="admin"

# wM API Gateway
export APIC_WM_GATEWAY_ADMIN_SECRET="wmapigateway-admin-secret"
export APIC_WM_GATEWAY_ADMIN_PASSWORD="manage"
export APIC_WM_GATEWAY_ENC_KEY_SECRET="wmapigateway-enc-key"
export APIC_WM_GATEWAY_ENC_KEY=""                        # Auto-generated if empty

# DevPortal
export APIC_DEVPORTAL_ENC_KEY_SECRET="devportal-enc-key"
export APIC_DEVPORTAL_ENC_KEY=""                         # Auto-generated if empty

#==============================================================================
# COMPONENT CONFIGURATION
#==============================================================================

# Management Cluster
export APIC_MGMT_REPLICAS="1"
export APIC_MGMT_LICENSE_ACCEPT="true"
export APIC_MGMT_LICENSE_USE="nonproduction"             # Options: production, nonproduction

# Analytics
export APIC_ANALYTICS_REPLICAS="1"
export APIC_ANALYTICS_LICENSE_ACCEPT="true"
export APIC_ANALYTICS_LICENSE_USE="nonproduction"

# wM API Gateway
export APIC_WM_GATEWAY_REPLICAS="1"
export APIC_WM_GATEWAY_LICENSE_ACCEPT="true"
export APIC_WM_GATEWAY_LICENSE_USE="nonproduction"

# AI DataPower Gateway
export APIC_AI_GATEWAY_REPLICAS="1"
export APIC_AI_GATEWAY_LICENSE_ACCEPT="true"
export APIC_AI_GATEWAY_LICENSE_USE="nonproduction"

# Developer Portal
export APIC_DEVPORTAL_REPLICAS="1"
export APIC_DEVPORTAL_LICENSE_ACCEPT="true"
export APIC_DEVPORTAL_LICENSE_USE="nonproduction"

#==============================================================================
# PROVIDER ORGANIZATION (API Manager)
#==============================================================================

# Provider Org definition
export PORG_NAME="adp"
export PORG_TITLE="API Developer Platform"

# Provider Org owner (local user created in Cloud Manager)
export PORG_OWNER_USERNAME="adp-admin"
export PORG_OWNER_PASSWORD="Admin123!"
export PORG_OWNER_EMAIL="adp-admin@adp.example.com"

#==============================================================================
# OPTIONAL: RESOURCE LIMITS (uncomment to override defaults)
#==============================================================================

# Management Cluster Resources
# export APIC_MGMT_CPU_REQUEST="1000m"
# export APIC_MGMT_CPU_LIMIT="4000m"
# export APIC_MGMT_MEMORY_REQUEST="1Gi"
# export APIC_MGMT_MEMORY_LIMIT="4Gi"

# Analytics Resources
# export APIC_ANALYTICS_CPU_REQUEST="500m"
# export APIC_ANALYTICS_CPU_LIMIT="2000m"
# export APIC_ANALYTICS_MEMORY_REQUEST="500Mi"
# export APIC_ANALYTICS_MEMORY_LIMIT="2Gi"

#==============================================================================
# OPTIONAL: EXTERNAL SERVICES
#==============================================================================

# External MSSQL (if using external database instead of embedded PostgreSQL)
# export APIC_EXTERNAL_DB_ENABLED="false"
# export APIC_EXTERNAL_DB_HOST="mssql-service"
# export APIC_EXTERNAL_DB_PORT="1433"
# export APIC_EXTERNAL_DB_NAME="apicdb"
# export APIC_EXTERNAL_DB_USERNAME="sa"
# export APIC_EXTERNAL_DB_PASSWORD=""

# External SMTP (for email notifications)
# export APIC_SMTP_ENABLED="false"
# export APIC_SMTP_HOST="maildev-service.apic.svc.cluster.local"
# export APIC_SMTP_PORT="1025"

#==============================================================================
# DEPLOYMENT OPTIONS
#==============================================================================

export APIC_DEPLOY_CORE="true"                           # Deploy Management + prerequisites
export APIC_DEPLOY_ANALYTICS="true"                      # Deploy Analytics
export APIC_DEPLOY_DEVPORTAL="true"                      # Deploy DevPortal (requires Analytics)
export APIC_DEPLOY_WM_GATEWAY="true"                     # Deploy wM API Gateway
export APIC_DEPLOY_AI_GATEWAY="true"                     # Deploy AI DataPower Gateway
export APIC_DEPLOY_DP_GATEWAY="false"                    # Deploy DataPower Gateway (v6)

export APIC_AUTO_REGISTER_SERVICES="false"               # Auto-register services after deployment

#==============================================================================
# DEBUGGING / LOGGING
#==============================================================================

export APIC_DEBUG="false"
export APIC_LOG_LEVEL="INFO"                             # Options: DEBUG, INFO, WARN, ERROR

################################################################################
# DO NOT EDIT BELOW THIS LINE
################################################################################

# Validate required variables
_validate_config() {
  local missing_vars=()

  [[ -z "${APIC_NAMESPACE}" ]] && missing_vars+=("APIC_NAMESPACE")
  [[ -z "${APIC_DOMAIN_BASE}" ]] && missing_vars+=("APIC_DOMAIN_BASE")
  [[ -z "${APIC_IMAGE_REGISTRY}" ]] && missing_vars+=("APIC_IMAGE_REGISTRY")
  [[ -z "${APIC_STORAGE_CLASS}" ]] && missing_vars+=("APIC_STORAGE_CLASS")
  [[ -z "${APIC_INGRESS_CLASS}" ]] && missing_vars+=("APIC_INGRESS_CLASS")

  if [[ ${#missing_vars[@]} -gt 0 ]]; then
    echo "ERROR: Missing required configuration variables:"
    printf '  - %s\n' "${missing_vars[@]}"
    return 1
  fi

  return 0
}

# Export all APIC_ variables
export_config() {
  if _validate_config; then
    echo "âœ“ Configuration loaded successfully"
    echo "  Package:       ${APIC_PACKAGE_NAME}"
    echo "  Namespace:     ${APIC_NAMESPACE}"
    echo "  Domain:        ${APIC_DOMAIN_BASE}"
    echo "  Registry:      ${APIC_IMAGE_REGISTRY}"
    echo "  Storage Class: ${APIC_STORAGE_CLASS}"
    echo "  Ingress Class: ${APIC_INGRESS_CLASS}"
    return 0
  else
    return 1
  fi
}

# Auto-export when sourced
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
  export_config
fi
